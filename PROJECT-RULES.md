# B2B Platform РІР‚вЂќ Р вЂ“РЎвЂРЎРѓРЎвЂљР С”Р С‘Р Вµ Р С—РЎР‚Р В°Р Р†Р С‘Р В»Р В° РЎР‚Р В°Р В·РЎР‚Р В°Р В±Р С•РЎвЂљР С”Р С‘

**Р вЂ™Р ВµРЎР‚РЎРѓР С‘РЎРЏ:** 1.0  
**Р вЂќР В°РЎвЂљР В°:** 13.12.2025  
**Р РЋРЎвЂљР В°РЎвЂљРЎС“РЎРѓ:** Р С™Р С›Р СњР РЋР СћР ВР СћР Р€Р В¦Р ВР Р‡ (Р Р…Р Вµ Р СР ВµР Р…РЎРЏРЎвЂљРЎРЉ Р В±Р ВµР В· РЎРѓР С•Р С–Р В»Р В°РЎРѓР С•Р Р†Р В°Р Р…Р С‘РЎРЏ)

---

## 1. Single Source of Truth (SSoT)

### Р СџРЎР‚Р В°Р Р†Р С‘Р В»Р С•: API Р С”Р С•Р Р…РЎвЂљРЎР‚Р В°Р С”РЎвЂљРЎвЂ№ РІР‚вЂќ Р Р† `api-contracts.yaml`, РЎвЂљР С•Р В»РЎРЉР С”Р С• Р Р† Р Р…РЎвЂР С

- **Р вЂ™РЎРѓР Вµ HTTP Р С—РЎС“РЎвЂљР С‘** (`/api/v1/*`) Р С•Р С—Р С‘РЎРѓР В°Р Р…РЎвЂ№ Р Р† `api-contracts.yaml` (OpenAPI 3.0).
- **Р вЂ™РЎРѓР Вµ РЎРѓРЎвЂ¦Р ВµР СРЎвЂ№ Р В·Р В°Р С—РЎР‚Р С•РЎРѓР С•Р Р†/Р С•РЎвЂљР Р†Р ВµРЎвЂљР С•Р Р†** РЎвЂћР С‘Р С”РЎРѓР С‘РЎР‚РЎС“РЎР‹РЎвЂљРЎРѓРЎРЏ Р Р† YAML Р С—Р ВµРЎР‚Р ВµР Т‘ РЎвЂљР ВµР С, Р С”Р В°Р С” Р С—Р С‘РЎРѓР В°РЎвЂљРЎРЉ Р С”Р С•Р Т‘.
- **Р вЂєРЎР‹Р В±Р С•Р Вµ Р С‘Р В·Р СР ВµР Р…Р ВµР Р…Р С‘Р Вµ API** (Р Р…Р С•Р Р†РЎвЂ№Р в„– Р С—Р В°РЎР‚Р В°Р СР ВµРЎвЂљРЎР‚, Р Р…Р С•Р Р†РЎвЂ№Р в„– РЎРѓРЎвЂљР В°РЎвЂљРЎС“РЎРѓ, Р Р…Р С•Р Р†Р С•Р Вµ Р С—Р С•Р В»Р Вµ) РІвЂ вЂ™ РЎРѓР Р…Р В°РЎвЂЎР В°Р В»Р В° Р Р† YAML, Р С—Р С•РЎвЂљР С•Р С Р Р† Р С”Р С•Р Т‘Р Вµ.
- **Р СџРЎР‚Р С‘ Р С—РЎР‚Р С•РЎвЂљР С‘Р Р†Р С•РЎР‚Р ВµРЎвЂЎР С‘Р С‘ Р СР ВµР В¶Р Т‘РЎС“ Р С”Р С•Р Т‘Р С•Р С Р С‘ YAML:** YAML Р Р†РЎРѓР ВµР С–Р Т‘Р В° Р С—РЎР‚Р В°Р Р†; Р С”Р С•Р Т‘ РІР‚вЂќ Р В±Р В°Р С–.

**Р РЋР В»Р ВµР Т‘РЎРѓРЎвЂљР Р†Р С‘Р Вµ:** Р вЂўРЎРѓР В»Р С‘ Р С—Р ВµРЎР‚Р ВµР ВµР В·Р В¶Р В°Р ВµР С РЎРѓ FastAPI Р Р…Р В° Node, Р С”Р С•Р Р…РЎвЂљРЎР‚Р В°Р С”РЎвЂљ Р Р…Р Вµ Р СР ВµР Р…РЎРЏР ВµРЎвЂљРЎРѓРЎРЏ. Р СљР ВµР Р…РЎРЏР ВµРЎвЂљРЎРѓРЎРЏ РЎвЂљР С•Р В»РЎРЉР С”Р С• РЎР‚Р ВµР В°Р В»Р С‘Р В·Р В°РЎвЂ Р С‘РЎРЏ.

---

## 2. Р С’РЎР‚РЎвЂ¦Р С‘РЎвЂљР ВµР С”РЎвЂљРЎС“РЎР‚Р В° (Clean + Hexagonal РЎС“Р С—РЎР‚Р С•РЎвЂ°РЎвЂР Р…Р Р…Р С•)

### Р С›Р В±РЎРЏР В·Р В°РЎвЂљР ВµР В»РЎРЉР Р…РЎвЂ№Р Вµ РЎРѓР В»Р С•Р С‘

```
backend/
  app/
    main.py                    # Р СћР С•Р В»РЎРЉР С”Р С• wiring Р С‘ Р С—Р С•Р Т‘Р С”Р В»РЎР‹РЎвЂЎР ВµР Р…Р С‘Р Вµ РЎР‚Р С•РЎС“РЎвЂљР ВµРЎР‚Р С•Р Р†
    config.py                  # Р С™Р С•Р Р…РЎвЂћР С‘Р С–РЎС“РЎР‚Р В°РЎвЂ Р С‘РЎРЏ (РЎвЂљР С•Р В»РЎРЉР С”Р С• env)
    
    transport/
      routers/                 # FastAPI РЎР‚Р С•РЎС“РЎвЂљРЎвЂ№ (Р С—РЎС“РЎвЂљРЎРЉ, Р С—Р В°РЎР‚Р В°Р СР ВµРЎвЂљРЎР‚РЎвЂ№, Pydantic DTO)
        __init__.py
        requests.py
        suppliers.py
        moderator.py
      schemas/                 # Pydantic DTO (Р Р†РЎвЂ¦Р С•Р Т‘/Р Р†РЎвЂ№РЎвЂ¦Р С•Р Т‘ Р С—Р С• API)
        __init__.py
        request_schemas.py
        supplier_schemas.py
      errors.py                # ErrorResponse, HTTPException helpers
      auth.py                  # JWT, Р В·Р В°Р Р†Р С‘РЎРѓР С‘Р СР С•РЎРѓРЎвЂљР С‘ Р Т‘Р В»РЎРЏ РЎР‚Р С•РЎС“РЎвЂљР С•Р Р†
    
    usecases/                  # Р вЂР С‘Р В·Р Р…Р ВµРЎРѓ-Р В»Р С•Р С–Р С‘Р С”Р В° (РЎРѓРЎвЂ Р ВµР Р…Р В°РЎР‚Р С‘Р С‘)
      __init__.py
      create_request.py        # CreateRequestUseCase
      submit_request.py
      search_suppliers.py
      send_email.py
      (Р С‘ РЎвЂљ.Р Т‘.)
    
    domain/                    # Р СљР С•Р Т‘Р ВµР В»Р С‘, Р С—РЎР‚Р В°Р Р†Р С‘Р В»Р В°, РЎвЂљР С‘Р С—РЎвЂ№ (Р вЂР вЂўР вЂ” РЎвЂћРЎР‚Р ВµР в„–Р СР Р†Р С•РЎР‚Р С”Р В°)
      __init__.py
      models.py                # @dataclass Request, Supplier, Key, etc
      errors.py                # DomainError, ValidationError
      rules.py                 # Р вЂР С‘Р В·Р Р…Р ВµРЎРѓ-Р С—РЎР‚Р В°Р Р†Р С‘Р В»Р В° (e.g., is_valid_supplier, PDF_MAX_PAGES)
    
    adapters/                  # Р ВР Р…РЎвЂљР ВµР С–РЎР‚Р В°РЎвЂ Р С‘Р С‘ (Р вЂР вЂќ, Р С—Р С•РЎвЂЎРЎвЂљР В°, Р Р†Р Р…Р ВµРЎв‚¬Р Р…Р С‘Р Вµ API)
      db/
        __init__.py
        models.py              # SQLAlchemy Р СР С•Р Т‘Р ВµР В»Р С‘ (Р СћР С›Р вЂєР В¬Р С™Р С› Р В·Р Т‘Р ВµРЎРѓРЎРЉ)
        repositories.py        # RequestRepository, SupplierRepository
        session.py             # get_db(), SessionLocal
      smtp/
        __init__.py
        client.py              # SMTP Р С•РЎвЂљР С—РЎР‚Р В°Р Р†Р С”Р В°
      imap/
        __init__.py
        client.py              # IMAP Р С—РЎР‚Р С‘РЎвЂР С
      checko/
        __init__.py
        client.py              # Р ВР Р…РЎвЂљР ВµР С–РЎР‚Р В°РЎвЂ Р С‘РЎРЏ РЎРѓ Checko API
      storage/
        __init__.py
        file_storage.py        # Р вЂ”Р В°Р С–РЎР‚РЎС“Р В·Р С”Р В° РЎвЂћР В°Р в„–Р В»Р С•Р Р†
    
    shared/                    # Р С›Р В±РЎвЂ°Р С‘Р Вµ РЎС“РЎвЂљР С‘Р В»Р С‘РЎвЂљРЎвЂ№
      logger.py
      utils.py
      constants.py

  tests/
    unit/                      # domain + usecases (Р В±Р ВµР В· Р вЂР вЂќ)
    integration/               # РЎРѓ Р В°Р Т‘Р В°Р С—РЎвЂљР ВµРЎР‚Р В°Р СР С‘ (Р вЂР вЂќ, SMTP)
    contract/                  # Р СџРЎР‚Р С•Р Р†Р ВµРЎР‚Р С”Р В° РЎРѓР С•Р С•РЎвЂљР Р†Р ВµРЎвЂљРЎРѓРЎвЂљР Р†Р С‘РЎРЏ api-contracts.yaml

  requirements.txt
  .env.example
  alembic/                     # Р СљР С‘Р С–РЎР‚Р В°РЎвЂ Р С‘Р С‘
    versions/
```

### Р СџРЎР‚Р В°Р Р†Р С‘Р В»Р В° РЎРѓР В»Р С•РЎвЂР Р†

1. **`transport`** (РЎвЂљР С•Р Р…Р С”Р С‘Р в„–):
   - Р СћР С•Р В»РЎРЉР С”Р С• Р С—Р В°РЎР‚РЎРѓР С‘РЎвЂљ HTTP request РІвЂ вЂ™ DTO (Pydantic).
   - Р СћР С•Р В»РЎРЉР С”Р С• Р Р†РЎвЂ№Р В·РЎвЂ№Р Р†Р В°Р ВµРЎвЂљ usecase.
   - Р СћР С•Р В»РЎРЉР С”Р С• Р Р†Р С•Р В·Р Р†РЎР‚Р В°РЎвЂ°Р В°Р ВµРЎвЂљ HTTP response (DTO РІвЂ вЂ™ JSON).
   - **Р СњР С‘Р С”Р В°Р С”Р С•Р в„– Р В±Р С‘Р В·Р Р…Р ВµРЎРѓ-Р В»Р С•Р С–Р С‘Р С”Р С‘.**

2. **`usecases`** (РЎРѓРЎР‚Р ВµР Т‘Р Р…Р С‘Р в„–):
   - Р вЂР С‘Р В·Р Р…Р ВµРЎРѓ-Р В»Р С•Р С–Р С‘Р С”Р В° РЎРѓРЎвЂ Р ВµР Р…Р В°РЎР‚Р С‘Р ВµР Р† (e.g., "Р С•РЎвЂљР С—РЎР‚Р В°Р Р†Р С‘РЎвЂљРЎРЉ Р С—Р С‘РЎРѓРЎРЉР СР С• Р С—Р С•РЎРѓРЎвЂљР В°Р Р†РЎвЂ°Р С‘Р С”РЎС“").
   - Р вЂ™РЎвЂ№Р В·РЎвЂ№Р Р†Р В°Р ВµРЎвЂљ domain Р С—РЎР‚Р В°Р Р†Р С‘Р В»Р В° Р С‘ Р В°Р Т‘Р В°Р С—РЎвЂљР ВµРЎР‚РЎвЂ№.
   - Р СљР С•Р В¶Р ВµРЎвЂљ Р В±РЎвЂ№РЎвЂљРЎРЉ async (Р Т‘Р В»РЎРЏ I/O Р Р† Р В°Р Т‘Р В°Р С—РЎвЂљР ВµРЎР‚Р В°РЎвЂ¦).
   - **Р СњР Вµ Р В·Р Р…Р В°Р ВµРЎвЂљ Р С—РЎР‚Р С• FastAPI, SQLAlchemy, Pydantic.**

3. **`domain`** (РЎРЏР Т‘РЎР‚Р С•):
   - Р В§Р С‘РЎРѓРЎвЂљРЎвЂ№Р в„– Python (dataclass, @dataclass, РЎвЂљР С‘Р С—Р С‘Р В·Р В°РЎвЂ Р С‘РЎРЏ).
   - Р вЂР С‘Р В·Р Р…Р ВµРЎРѓ-Р С—РЎР‚Р В°Р Р†Р С‘Р В»Р В° (Р Р†Р В°Р В»Р С‘Р Т‘Р В°РЎвЂ Р С‘РЎРЏ, РЎРѓРЎвЂљР В°РЎвЂљРЎС“РЎРѓРЎвЂ№, Р С”Р С•Р Р…РЎРѓРЎвЂљР В°Р Р…РЎвЂљРЎвЂ№).
   - Р СњР С‘Р С”Р В°Р С”Р С‘РЎвЂ¦ Р С‘Р СР С—Р С•РЎР‚РЎвЂљР С•Р Р† Р С‘Р В· Р Т‘РЎР‚РЎС“Р С–Р С‘РЎвЂ¦ РЎРѓР В»Р С•РЎвЂР Р†.
   - Р СњР С‘Р С”Р В°Р С”Р С‘РЎвЂ¦ fastapi, sqlalchemy, requests.
   - **Р СџР ВµРЎР‚Р ВµР Р…Р С•РЎРѓР С‘Р СР С• Р Р…Р В° Node/Go/Java Р В±Р ВµР В· Р С‘Р В·Р СР ВµР Р…Р ВµР Р…Р С‘Р в„– (Р В»Р С•Р С–Р С‘Р С”Р В°).**

4. **`adapters`** (Р С”Р С•Р Р…Р С”РЎР‚Р ВµРЎвЂљР С‘Р С”Р В°):
   - SQLAlchemy Р СР С•Р Т‘Р ВµР В»Р С‘ (Р СћР С›Р вЂєР В¬Р С™Р С› Р В·Р Т‘Р ВµРЎРѓРЎРЉ).
   - Р ВР Р…РЎвЂљР ВµР С–РЎР‚Р В°РЎвЂ Р С‘Р С‘ РЎРѓ Р Р†Р Р…Р ВµРЎв‚¬Р Р…Р С‘Р СР С‘ РЎРѓР ВµРЎР‚Р Р†Р С‘РЎРѓР В°Р СР С‘ (SMTP, IMAP, HTTP, S3).
   - Repositories (QueryObject pattern).
   - **Р вЂўРЎРѓР В»Р С‘ Р В·Р В°Р СР ВµР Р…РЎРЏР ВµР С Р вЂР вЂќ РЎРѓ Postgres Р Р…Р В° MySQL: Р СР ВµР Р…РЎРЏР ВµР С РЎвЂљР С•Р В»РЎРЉР С”Р С• Р В·Р Т‘Р ВµРЎРѓРЎРЉ.**

---

## 3. Р С™Р С•Р Р…РЎвЂћР С‘Р С–РЎС“РЎР‚Р В°РЎвЂ Р С‘РЎРЏ (12-Factor)

### Р СџРЎР‚Р В°Р Р†Р С‘Р В»Р С•: Р вЂ™РЎРѓР Вµ Р Р…Р В°РЎРѓРЎвЂљРЎР‚Р С•Р в„–Р С”Р С‘ РЎвЂљР С•Р В»РЎРЉР С”Р С• РЎвЂЎР ВµРЎР‚Р ВµР В· environment Р С—Р ВµРЎР‚Р ВµР СР ВµР Р…Р Р…РЎвЂ№Р Вµ

- Р СњР С‘ Р С•Р Т‘Р Р…Р С•Р С–Р С• hardcode'Р В° Р Р† Р С”Р С•Р Т‘Р Вµ.
- Р С™Р В»РЎР‹РЎвЂЎР С‘, Р С—Р В°РЎР‚Р С•Р В»Р С‘, URL РІР‚вЂќ РЎвЂљР С•Р В»РЎРЉР С”Р С• Р Р† `.env` (Р Р…Р Вµ Р С”Р С•Р СР СР С‘РЎвЂљРЎРЏРЎвЂљРЎРѓРЎРЏ).
- `.env.example` РІР‚вЂќ Р С—РЎР‚Р С‘Р СР ВµРЎР‚ Р Р†РЎРѓР ВµРЎвЂ¦ РЎвЂљРЎР‚Р ВµР В±РЎС“Р ВµР СРЎвЂ№РЎвЂ¦ Р С—Р ВµРЎР‚Р ВµР СР ВµР Р…Р Р…РЎвЂ№РЎвЂ¦ (Р В±Р ВµР В·Р С•Р С—Р В°РЎРѓР Р…РЎвЂ№Р в„–).
- Р СџР С•РЎвЂљР С•Р С”: `config.py` РЎвЂЎР С‘РЎвЂљР В°Р ВµРЎвЂљ env РІвЂ вЂ™ Pydantic Settings РІвЂ вЂ™ Р С‘РЎРѓР С—Р С•Р В»РЎРЉР В·РЎС“Р ВµРЎвЂљРЎРѓРЎРЏ Р Р†Р ВµР В·Р Т‘Р Вµ.

**Р СџРЎР‚Р С‘Р СР ВµРЎР‚ `config.py`:**
```python
from pydantic_settings import BaseSettings

class Settings(BaseSettings):
    APP_HOST: str = "0.0.0.0"
    APP_PORT: int = 8000
    API_PREFIX: str = "/api/v1"
    DATABASE_URL: str
    CHECKO_API_KEY: str
    PDF_MAX_PAGES: int = 3
    TRGM_SIMILARITY: float = 0.78
    JWT_SECRET: str
    
    class Config:
        env_file = ".env"

settings = Settings()
```

---

## 4. DTO РІвЂ°В  Domain

### Р СџРЎР‚Р В°Р Р†Р С‘Р В»Р С•: Р вЂ™РЎвЂ¦Р С•Р Т‘Р Р…РЎвЂ№Р Вµ/Р Р†РЎвЂ№РЎвЂ¦Р С•Р Т‘Р Р…РЎвЂ№Р Вµ РЎРѓРЎвЂ¦Р ВµР СРЎвЂ№ (Pydantic) Р С•РЎвЂљР Т‘Р ВµР В»Р ВµР Р…РЎвЂ№ Р С•РЎвЂљ Р Т‘Р С•Р СР ВµР Р…Р Р…РЎвЂ№РЎвЂ¦ Р СР С•Р Т‘Р ВµР В»Р ВµР в„–

**Р СџРЎР‚Р С‘Р СР ВµРЎР‚:**
```python
# РІСњРЉ Р СњР вЂўР СџР В Р С’Р вЂ™Р ВР вЂєР В¬Р СњР С› (domain Р С‘ API Р С•Р Т‘Р Р…Р С• Р С‘ РЎвЂљР С• Р В¶Р Вµ):
class Request(Base):  # SQLAlchemy ORM
    id: int
    status: str
    # ... Р С‘ РЎРЊРЎвЂљР С• Р В¶Р Вµ Р Р†Р С•Р В·Р Р†РЎР‚Р В°РЎвЂ°Р В°Р ВµР С Р Р† API

# РІСљвЂ¦ Р СџР В Р С’Р вЂ™Р ВР вЂєР В¬Р СњР С›:

# domain/models.py РІР‚вЂќ Р В»Р С•Р С–Р С‘Р С”Р В°
@dataclass
class Request:
    id: int
    status: RequestStatus  # Enum
    title: str | None
    # ... РЎвЂљР С•Р В»РЎРЉР С”Р С• Р С—Р С•Р В»РЎРЏ, Р Р…РЎС“Р В¶Р Р…РЎвЂ№Р Вµ Р Т‘Р В»РЎРЏ Р В»Р С•Р С–Р С‘Р С”Р С‘

# adapters/db/models.py РІР‚вЂќ Р вЂР вЂќ
class RequestModel(Base):
    __tablename__ = "requests"
    id = Column(Integer, primary_key=True)
    status = Column(String(50))
    # ... Р С—Р С•Р В»РЎРЏ Р вЂР вЂќ

# transport/schemas.py РІР‚вЂќ API
class RequestResponse(BaseModel):
    id: int
    status: str  # Р РЋР ВµРЎР‚Р С‘Р В°Р В»Р С‘Р В·РЎС“Р ВµРЎвЂљРЎРѓРЎРЏ Р С”Р В°Р С” РЎРѓРЎвЂљРЎР‚Р С•Р С”Р В° Р Р† JSON
    title: str | None
```

**Р СџР С•РЎвЂЎР ВµР СРЎС“:** 
- API Р СР С•Р В¶Р ВµРЎвЂљ Р С•РЎвЂљР В»Р С‘РЎвЂЎР В°РЎвЂљРЎРЉРЎРѓРЎРЏ Р С•РЎвЂљ Р вЂР вЂќ.
- Domain Р Р…Р Вµ Р Т‘Р С•Р В»Р В¶Р ВµР Р… Р СР ВµР Р…РЎРЏРЎвЂљРЎРЉ Р С—РЎР‚Р С‘ Р С‘Р В·Р СР ВµР Р…Р ВµР Р…Р С‘Р С‘ API.
- Р СџРЎР‚Р С‘ Р С—Р ВµРЎР‚Р ВµР ВµР В·Р Т‘Р Вµ Р Р…Р В° Node: domain Р В»Р С•Р С–Р С‘Р С”Р В° Р С•Р Т‘Р Р…Р В°, Р Р…Р С• Pydantic РІвЂ вЂ™ TypeScript/class-validator.

---

## 5. Р С™Р С•Р Р…РЎвЂљРЎР‚Р В°Р С”РЎвЂљ-РЎвЂљР ВµРЎРѓРЎвЂљРЎвЂ№ (РЎРѓР С”Р С•РЎР‚Р С•)

### Р СџРЎР‚Р В°Р Р†Р С‘Р В»Р С•: Р вЂўРЎРѓРЎвЂљРЎРЉ РЎвЂљР ВµРЎРѓРЎвЂљРЎвЂ№, Р С—РЎР‚Р С•Р Р†Р ВµРЎР‚РЎРЏРЎР‹РЎвЂ°Р С‘Р Вµ РЎвЂЎРЎвЂљР С• РЎР‚Р ВµР В°Р В»РЎРЉР Р…РЎвЂ№Р в„– API РЎРѓР С•Р С•РЎвЂљР Р†Р ВµРЎвЂљРЎРѓРЎвЂљР Р†РЎС“Р ВµРЎвЂљ `api-contracts.yaml`

- `tests/contract/` РІР‚вЂќ Р С‘РЎРѓР С—Р С•Р В»РЎРЉР В·РЎС“РЎР‹РЎвЂљ Schemathesis Р С‘Р В»Р С‘ OpenAPI-validator.
- Р вЂњР С•Р Р…РЎРЏРЎвЂљ Р Р…Р В° Р С”Р В°Р В¶Р Т‘РЎвЂ№Р в„– Р С”Р С•Р СР СР С‘РЎвЂљ (Р С‘Р В»Р С‘ CI/CD).
- **Р вЂўРЎРѓР В»Р С‘ API Р Р…Р В°РЎР‚РЎС“РЎв‚¬Р В°Р ВµРЎвЂљ Р С”Р С•Р Р…РЎвЂљРЎР‚Р В°Р С”РЎвЂљ РІвЂ вЂ™ build Р С—Р В°Р Т‘Р В°Р ВµРЎвЂљ, Р Р…Р Вµ Р СРЎвЂРЎР‚Р В¶Р С‘Р С.**

---

## 6. Р СњР С‘Р С”Р В°Р С”Р С‘РЎвЂ¦ "Р В±РЎвЂ№РЎРѓРЎвЂљРЎР‚РЎвЂ№РЎвЂ¦ РЎвЂ¦Р В°Р С”Р С•Р Р†" Р Р† Р С”Р С•Р Т‘Р Вµ

### Р СџРЎР‚Р В°Р Р†Р С‘Р В»Р С•: Р СњР ВµР Т‘Р С•Р С—РЎС“РЎРѓРЎвЂљР С‘Р СР С•

РІСњРЉ Р СџР С•Р СР ВµРЎвЂ°Р ВµР Р…Р С‘Р Вµ Р С—Р В°РЎР‚Р С•Р В»РЎРЏ Р Р† `main.py`  
РІСњРЉ SQL Р В·Р В°Р С—РЎР‚Р С•РЎРѓРЎвЂ№ inline (Р В±Р ВµР В· repository)  
РІСњРЉ `# TODO` Р С”Р С•Р СР СР ВµР Р…РЎвЂљР В°РЎР‚Р С‘Р С‘ (todo Р С—Р ВµРЎР‚Р ВµР СР ВµРЎвЂ°Р В°РЎР‹РЎвЂљРЎРѓРЎРЏ Р Р† Issues)  
РІСњРЉ Р ВР СР С—Р С•РЎР‚РЎвЂљР С‘РЎР‚Р С•Р Р†Р В°Р Р…Р С‘Р Вµ `app` Р С‘Р В· Р Т‘РЎР‚РЎС“Р С–Р С‘РЎвЂ¦ Р СР С•Р Т‘РЎС“Р В»Р ВµР в„– (circular imports)  
РІСњРЉ Р вЂњР В»Р С•Р В±Р В°Р В»РЎРЉР Р…Р С•Р Вµ РЎРѓР С•РЎРѓРЎвЂљР С•РЎРЏР Р…Р С‘Р Вµ (Р С”РЎР‚Р С•Р СР Вµ Р С”Р С•Р Р…РЎвЂћР С‘Р С–Р В°)  
РІСњРЉ Async/await Р Р† domain РЎРѓР В»Р С•Р Вµ (domain РЎРѓР С‘Р Р…РЎвЂ¦РЎР‚Р С•Р Р…Р ВµР Р…)  

### Р вЂќР С•Р С—РЎС“РЎРѓРЎвЂљР С‘Р СР С•

РІСљвЂ¦ Р СњР С•Р Р†Р В°РЎРЏ РЎвЂћР С‘РЎвЂЎР С”Р В° Р С”Р В°Р С” Р С•РЎвЂљР Т‘Р ВµР В»РЎРЉР Р…РЎвЂ№Р в„– usecase (Р Т‘Р В°Р В¶Р Вµ Р ВµРЎРѓР В»Р С‘ Р Р†РЎР‚Р ВµР СР ВµР Р…Р Р…РЎвЂ№Р в„–)  
РІСљвЂ¦ Mock Р В°Р Т‘Р В°Р С—РЎвЂљР ВµРЎР‚РЎвЂ№ Р Т‘Р В»РЎРЏ РЎвЂљР ВµРЎРѓРЎвЂљР С•Р Р†  
РІСљвЂ¦ Feature flags РЎвЂЎР ВµРЎР‚Р ВµР В· env (Р ВµРЎРѓР В»Р С‘ Р Р…РЎС“Р В¶Р Р…Р С•)  

---

## 7. Р СџРЎР‚Р С‘Р Р†РЎРЏР В·Р С”Р В° Р С” РЎвЂћРЎР‚Р ВµР в„–Р СР Р†Р С•РЎР‚Р С”РЎС“ (Р В·Р В°Р С—РЎР‚Р ВµРЎвЂ°Р ВµР Р…Р С• Р Р† domain Р С‘ usecases)

### Р СџРЎР‚Р В°Р Р†Р С‘Р В»Р С•: FastAPI Р С‘ SQLAlchemy РІР‚вЂќ РЎвЂљР С•Р В»РЎРЉР С”Р С• Р Р† `transport` Р С‘ `adapters`

**Р СџР С•Р С”РЎР‚РЎвЂ№РЎвЂљР С• Р Р†РЎвЂ№РЎв‚¬Р Вµ (Р В°РЎР‚РЎвЂ¦Р С‘РЎвЂљР ВµР С”РЎвЂљРЎС“РЎР‚Р В°), Р Р…Р С• Р ВµРЎвЂ°РЎвЂ РЎР‚Р В°Р В·:**

```python
# РІСњРЉ Р вЂ™ domain/usecases:
from fastapi import HTTPException
from sqlalchemy.orm import Session
import requests

# РІСљвЂ¦ Р вЂ™Р СР ВµРЎРѓРЎвЂљР С• РЎРЊРЎвЂљР С•Р С–Р С•:
# - domain Р Р†РЎвЂ№Р В±РЎР‚Р В°РЎРѓРЎвЂ№Р Р†Р В°Р ВµРЎвЂљ DomainError, usecase Р С—Р ВµРЎР‚Р ВµР Р†Р С•Р Т‘Р С‘РЎвЂљ Р Р† HTTPException
# - Repositories (Р В°Р Т‘Р В°Р С—РЎвЂљР ВµРЎР‚РЎвЂ№) РЎР‚Р В°Р В±Р С•РЎвЂљР В°РЎР‹РЎвЂљ РЎРѓ ORMs
# - Р С’Р Т‘Р В°Р С—РЎвЂљР ВµРЎР‚РЎвЂ№ Р Р†РЎвЂ№Р В·РЎвЂ№Р Р†Р В°РЎР‹РЎвЂљ Р Р†Р Р…Р ВµРЎв‚¬Р Р…Р С‘Р Вµ API, domain Р Р…Р Вµ Р В·Р Р…Р В°Р ВµРЎвЂљ Р С—РЎР‚Р С• requests
```

---

## 8. Р СџР ВµРЎР‚Р ВµР ВµР В·Р Т‘ Р Р…Р В° Node Р Т‘Р С•Р В»Р В¶Р ВµР Р… Р В±РЎвЂ№РЎвЂљРЎРЉ Р Р†Р С•Р В·Р СР С•Р В¶Р ВµР Р…

### Р СџРЎР‚Р В°Р Р†Р С‘Р В»Р С•: Р С™Р С•Р Т‘ Р С—Р С‘РЎв‚¬Р ВµРЎвЂљРЎРѓРЎРЏ "РЎвЂљРЎР‚Р В°Р Р…РЎРѓР С—Р С•РЎР‚РЎвЂљР В°Р В±Р ВµР В»РЎРЉР Р…Р С•"

**Р В§РЎвЂљР С• РЎРЊРЎвЂљР С• Р В·Р Р…Р В°РЎвЂЎР С‘РЎвЂљ:**
- Usecase = РЎвЂЎР С‘РЎРѓРЎвЂљР В°РЎРЏ РЎвЂћРЎС“Р Р…Р С”РЎвЂ Р С‘РЎРЏ (Р СР С•Р В¶Р Р…Р С• Р С—Р ВµРЎР‚Р ВµР С—Р С‘РЎРѓР В°РЎвЂљРЎРЉ Р Р…Р В° Node РЎвЂљР В°Р С”РЎС“РЎР‹ Р В¶Р Вµ Р В»Р С•Р С–Р С‘Р С”РЎС“).
- Domain Р СР С•Р Т‘Р ВµР В»Р С‘ = Р С—РЎР‚Р С•РЎРѓРЎвЂљР С• РЎРѓРЎвЂљРЎР‚РЎС“Р С”РЎвЂљРЎС“РЎР‚РЎвЂ№ Р Т‘Р В°Р Р…Р Р…РЎвЂ№РЎвЂ¦ + Р С—РЎР‚Р В°Р Р†Р С‘Р В»Р В° (Р С—Р С•РЎР‚РЎвЂљР С‘РЎР‚РЎС“РЎР‹РЎвЂљРЎРѓРЎРЏ Р С”Р В°Р С” Р С”Р В»Р В°РЎРѓРЎРѓРЎвЂ№/Р С‘Р Р…РЎвЂљР ВµРЎР‚РЎвЂћР ВµР в„–РЎРѓРЎвЂ№).
- Adapters = Р В·Р В°Р СР ВµР Р…РЎРЏР ВµР СРЎвЂ№Р Вµ Р В±Р В»Р С•Р С”Р С‘ (SQLAlchemy РІвЂ вЂ™ Prisma/TypeORM).
- Tests, Р С”Р С•РЎвЂљР С•РЎР‚РЎвЂ№Р Вµ РЎвЂљР ВµРЎРѓРЎвЂљР С‘РЎР‚РЎС“РЎР‹РЎвЂљ Р С—Р С•Р Р†Р ВµР Т‘Р ВµР Р…Р С‘Р Вµ (Р В° Р Р…Р Вµ РЎР‚Р ВµР В°Р В»Р С‘Р В·Р В°РЎвЂ Р С‘РЎР‹), Р С•РЎРѓРЎвЂљР В°РЎР‹РЎвЂљРЎРѓРЎРЏ Р В°Р С”РЎвЂљРЎС“Р В°Р В»РЎРЉР Р…РЎвЂ№.

**Р В§РЎвЂљР С• Р СњР вЂў Р Т‘Р С•Р В»Р В¶Р Р…Р С• Р В±РЎвЂ№РЎвЂљРЎРЉ Р Р† Р С”Р С•Р Т‘Р Вµ:**
- FastAPI decorators Р Р†Р Р…РЎС“РЎвЂљРЎР‚Р С‘ usecases.
- SQLAlchemy sessions, passed into usecases.
- Р вЂ”Р В°Р Р†Р С‘РЎРѓР С‘Р СР С•РЎРѓРЎвЂљР С‘ Р С•РЎвЂљ Python-РЎРѓР С—Р ВµРЎвЂ Р С‘РЎвЂћР С‘РЎвЂЎР Р…РЎвЂ№РЎвЂ¦ РЎвЂћР С‘РЎвЂЎ (Р ВµРЎРѓР В»Р С‘ Р СР С•Р В¶Р Р…Р С• Р С—Р С•-РЎС“Р Р…Р С‘Р Р†Р ВµРЎР‚РЎРѓР В°Р В»РЎРЉР Р…Р ВµР Вµ).

---

## 9. Р вЂ™Р ВµРЎР‚РЎРѓР С‘Р С•Р Р…Р С‘РЎР‚Р С•Р Р†Р В°Р Р…Р С‘Р Вµ Р С‘ РЎРѓР С•Р Р†Р СР ВµРЎРѓРЎвЂљР С‘Р СР С•РЎРѓРЎвЂљРЎРЉ

### Р СџРЎР‚Р В°Р Р†Р С‘Р В»Р С•: API Р Р†Р ВµРЎР‚РЎРѓР С‘РЎР‚РЎС“Р ВµРЎвЂљРЎРѓРЎРЏ РЎвЂЎР ВµРЎР‚Р ВµР В· Р С—РЎС“РЎвЂљРЎРЉ `/api/v1`, `/api/v2`, etc.

- Р вЂќР С•Р В±Р В°Р Р†Р В»Р ВµР Р…Р С‘Р Вµ Р Р…Р С•Р Р†Р С•Р С–Р С• Р С—Р С•Р В»РЎРЏ Р Р† Р С•РЎвЂљР Р†Р ВµРЎвЂљР Вµ = Р СР С•Р В¶Р Р…Р С• (backward compatible).
- Р Р€Р Т‘Р В°Р В»Р ВµР Р…Р С‘Р Вµ Р С—Р С•Р В»РЎРЏ = Р Р…Р С•Р Р†Р В°РЎРЏ Р Р†Р ВµРЎР‚РЎРѓР С‘РЎРЏ API.
- Р СџР ВµРЎР‚Р ВµР С‘Р СР ВµР Р…Р С•Р Р†Р В°Р Р…Р С‘Р Вµ Р С—Р С•Р В»РЎРЏ = Р Р…Р С•Р Р†Р В°РЎРЏ Р Р†Р ВµРЎР‚РЎРѓР С‘РЎРЏ.
- Р ВР В·Р СР ВµР Р…Р ВµР Р…Р С‘Р Вµ РЎвЂљР С‘Р С—Р В° = Р Р…Р С•Р Р†Р В°РЎРЏ Р Р†Р ВµРЎР‚РЎРѓР С‘РЎРЏ.

**Р СџР С•Р С”Р В° Р Р†РЎРѓР ВµР С–Р Т‘Р В° v1, Р Р…Р С• РЎРѓР С”Р ВµР В»Р ВµРЎвЂљ Р Р…РЎС“Р В¶Р ВµР Р….**

---

## 10. Р вЂєР С•Р С–Р С‘РЎР‚Р С•Р Р†Р В°Р Р…Р С‘Р Вµ Р С‘ Р СР С•Р Р…Р С‘РЎвЂљР С•РЎР‚Р С‘Р Р…Р С–

### Р СџРЎР‚Р В°Р Р†Р С‘Р В»Р С•: Р РЋРЎвЂљРЎР‚РЎС“Р С”РЎвЂљРЎС“РЎР‚Р С‘РЎР‚Р С•Р Р†Р В°Р Р…Р Р…РЎвЂ№Р в„– Р В»Р С•Р С–Р С‘РЎР‚Р С•Р Р†Р В°Р Р…Р С‘Р Вµ

```python
import logging
from pythonjsonlogger import jsonlogger

logger = logging.getLogger(__name__)
handler = logging.StreamHandler()
formatter = jsonlogger.JsonFormatter()
handler.setFormatter(formatter)
logger.addHandler(handler)
```

**Р В§РЎвЂљР С• Р В»Р С•Р С–Р С‘РЎР‚РЎС“Р ВµР С:**
- РІСљвЂ¦ Р СњР В°РЎвЂЎР В°Р В»Р С•/Р С”Р С•Р Р…Р ВµРЎвЂ  usecase (РЎРѓ Р Р†РЎР‚Р ВµР СР ВµР Р…Р ВµР С)
- РІСљвЂ¦ Р С›РЎв‚¬Р С‘Р В±Р С”Р С‘ (РЎРѓ РЎвЂљРЎР‚Р В°РЎРѓРЎРѓР С‘РЎР‚Р С•Р Р†Р С”Р С•Р в„–)
- РІСљвЂ¦ Р ВР Р…РЎвЂљР ВµР С–РЎР‚Р В°РЎвЂ Р С‘Р С‘ (Р В·Р В°Р С—РЎР‚Р С•РЎРѓРЎвЂ№ Р С” Checko, SMTP, Р вЂР вЂќ)
- РІСњРЉ Р СџР В°РЎР‚Р С•Р В»Р С‘, JWT, Р С—РЎР‚Р С‘Р Р†Р В°РЎвЂљР Р…РЎвЂ№Р Вµ Р С”Р В»РЎР‹РЎвЂЎР С‘

---

## 11. Р СћР ВµРЎРѓРЎвЂљРЎвЂ№ (Р С•Р В±РЎРЏР В·Р В°РЎвЂљР ВµР В»РЎРЉР Р…РЎвЂ№)

### Р РЋР В»Р С•Р С‘ РЎвЂљР ВµРЎРѓРЎвЂљР С•Р Р†

1. **Unit (`tests/unit/`)**: domain + usecases, Р вЂР вЂўР вЂ” Р вЂР вЂќ
   - Р вЂРЎвЂ№РЎРѓРЎвЂљРЎР‚РЎвЂ№Р Вµ, Р С‘Р В·Р С•Р В»Р С‘РЎР‚Р С•Р Р†Р В°Р Р…Р Р…РЎвЂ№Р Вµ.
   - Mock Р В°Р Т‘Р В°Р С—РЎвЂљР ВµРЎР‚Р С•Р Р†.

2. **Integration (`tests/integration/`)**: РЎРѓ Р В°Р Т‘Р В°Р С—РЎвЂљР ВµРЎР‚Р В°Р СР С‘ (Р вЂР вЂќ, SMTP)
   - Р СљР ВµР Т‘Р В»Р ВµР Р…Р Р…Р ВµР Вµ, Р Р…Р С• РЎР‚Р ВµР В°Р В»РЎРЉР Р…РЎвЂ№Р Вµ Р С‘Р Р…РЎвЂљР ВµР С–РЎР‚Р В°РЎвЂ Р С‘Р С‘.
   - Р СњР В° РЎРѓР ВµР в„–РЎвЂЎР В°РЎРѓ: РЎРѓ РЎвЂљР ВµРЎРѓРЎвЂљР С•Р Р†Р С•Р в„– Р вЂР вЂќ.

3. **Contract (`tests/contract/`)**: API РЎРѓР С•Р С•РЎвЂљР Р†Р ВµРЎвЂљРЎРѓРЎвЂљР Р†РЎС“Р ВµРЎвЂљ Р С”Р С•Р Р…РЎвЂљРЎР‚Р В°Р С”РЎвЂљРЎС“
   - Schemathesis Р С‘Р В»Р С‘ openapi-spec-validator.

**Р СљР С‘Р Р…Р С‘Р СРЎС“Р С Р С—Р С•Р С”РЎР‚РЎвЂ№РЎвЂљР С‘РЎРЏ:**
- Р Р€РЎРѓР С—Р ВµРЎв‚¬Р Р…РЎвЂ№Р в„– РЎРѓРЎвЂ Р ВµР Р…Р В°РЎР‚Р С‘Р в„– (happy path).
- Р С›РЎРѓР Р…Р С•Р Р†Р Р…РЎвЂ№Р Вµ Р С•РЎв‚¬Р С‘Р В±Р С”Р С‘ (Р Р†Р В°Р В»Р С‘Р Т‘Р В°РЎвЂ Р С‘РЎРЏ, Р Р…Р Вµ Р Р…Р В°Р в„–Р Т‘Р ВµР Р…Р С•, Р С”Р С•Р Р…РЎвЂћР В»Р С‘Р С”РЎвЂљ).

---

## 12. Р вЂ”Р В°Р Р†Р С‘РЎРѓР С‘Р СР С•РЎРѓРЎвЂљР С‘ (requirements.txt)

**Р СљР С‘Р Р…Р С‘Р СРЎС“Р С Р Т‘Р В»РЎРЏ MVP:**
```
fastapi==0.109.2
uvicorn[standard]==0.27.0
pydantic==2.5.3
pydantic-settings==2.1.0
sqlalchemy==2.0.23
psycopg2-binary==2.9.9
asyncpg==0.29.0
alembic==1.13.1
python-dotenv==1.0.0
python-multipart==0.0.6
aiofiles==23.2.1
```

**Р вЂ”Р В°Р С—РЎР‚Р ВµРЎвЂ°Р ВµР Р…Р С•:**
- Р РЋРЎвЂљР В°РЎР‚РЎвЂ№Р Вµ Р Р†Р ВµРЎР‚РЎРѓР С‘Р С‘ (Р В±Р ВµР В· РЎвЂљР С‘Р С—Р С‘Р В·Р В°РЎвЂ Р С‘Р С‘, Р В±Р ВµР В· async).
- Р вЂќРЎС“Р В±Р В»Р С‘РЎР‚РЎС“РЎР‹РЎвЂ°Р С‘Р Вµ Р С—Р В°Р С”Р ВµРЎвЂљРЎвЂ№ (e.g., requests + httpx Р С•Р Т‘Р Р…Р С•Р Р†РЎР‚Р ВµР СР ВµР Р…Р Р…Р С•).

---

## 13. Р С™Р В°Р С” Р В·Р В°Р С—РЎС“РЎРѓР С”Р В°РЎвЂљРЎРЉ Р В±Р ВµР В· Р В·Р В°Р С–Р В»РЎС“РЎв‚¬Р ВµР С”

### Р СџРЎР‚Р В°Р Р†Р С‘Р В»Р С•: Р С™Р В°Р В¶Р Т‘РЎвЂ№Р в„– endpoint РЎР‚Р ВµР В°Р В»Р ВµР Р…, РЎР‚Р В°Р В±Р С•РЎвЂљР В°Р ВµРЎвЂљ, Р С—РЎР‚Р С•РЎвЂљР ВµРЎРѓРЎвЂљР С‘РЎР‚Р С•Р Р†Р В°Р Р…

Р вЂўРЎРѓР В»Р С‘ endpoint Р Р…РЎС“Р В¶Р ВµР Р…, Р Р…Р С• Р В»Р С•Р С–Р С‘Р С”Р В° "Р С—Р С•Р В·Р В¶Р Вµ":
1. Р вЂќР С•Р В±Р В°Р Р†Р С‘РЎвЂљРЎРЉ Р Р† OpenAPI.
2. Р В Р ВµР В°Р В»Р С‘Р В·Р С•Р Р†Р В°РЎвЂљРЎРЉ Р С”Р В°Р С” `NotImplementedError` (Р С‘Р В»Р С‘ 501 Not Implemented).
3. Р ВР В»Р С‘ РЎР‚Р ВµР В°Р В»Р С‘Р В·Р С•Р Р†Р В°РЎвЂљРЎРЉ MVP Р Р†Р ВµРЎР‚РЎРѓР С‘РЎР‹ (Р Р…Р Вµ mock, Р В° Р Р…Р В°РЎРѓРЎвЂљР С•РЎРЏРЎвЂ°Р В°РЎРЏ, Р Р…Р С• Р СР С•Р В¶Р ВµРЎвЂљ Р В±РЎвЂ№РЎвЂљРЎРЉ Р С—РЎР‚Р С•РЎРѓРЎвЂљР В°РЎРЏ).

**Р СџРЎР‚Р С‘Р СР ВµРЎР‚: `/user/requests` (РЎРѓР С•Р В·Р Т‘Р В°Р Р…Р С‘Р Вµ)**
- Р вЂ™РЎвЂ¦Р С•Р Т‘: file (multipart) Р С‘Р В»Р С‘ JSON РЎРѓ Р С”Р В»РЎР‹РЎвЂЎР В°Р СР С‘.
- Р вЂ™РЎвЂ№РЎвЂ¦Р С•Р Т‘: RequestResponse (id, status=draft, ...).
- **Р В­РЎвЂљР С• РЎР‚Р В°Р В±Р С•РЎвЂљР В°Р ВµРЎвЂљ Р С‘ Р Р†РЎРѓР ВµР С–Р Т‘Р В°** (Р С—Р В°РЎР‚РЎРѓР С‘Р Р…Р С– РЎвЂћР В°Р в„–Р В»Р В° Р СР С•Р В¶Р ВµРЎвЂљ Р В±РЎвЂ№РЎвЂљРЎРЉ РЎС“Р С—РЎР‚Р С•РЎвЂ°РЎвЂР Р…, Р Р…Р С• РЎРѓРЎвЂљРЎР‚РЎС“Р С”РЎвЂљРЎС“РЎР‚Р В° РЎвЂЎР ВµРЎРѓРЎвЂљР Р…Р В°РЎРЏ).

---

## 14. Workflow Р С—РЎР‚Р С‘ РЎР‚Р В°Р В·РЎР‚Р В°Р В±Р С•РЎвЂљР С”Р Вµ

### Р РЃР В°Р С– 1: Р С›Р В±Р Р…Р С•Р Р†Р С‘РЎвЂљРЎРЉ Р С”Р С•Р Р…РЎвЂљРЎР‚Р В°Р С”РЎвЂљ
```bash
# Р С›РЎвЂљРЎР‚Р ВµР Т‘Р В°Р С”РЎвЂљР С‘РЎР‚Р С•Р Р†Р В°РЎвЂљРЎРЉ api-contracts.yaml
# Р вЂќР С•Р В±Р В°Р Р†Р С‘РЎвЂљРЎРЉ Р Р…Р С•Р Р†РЎвЂ№Р в„– endpoint / Р Р…Р С•Р Р†Р С•Р Вµ Р С—Р С•Р В»Р Вµ / Р Р…Р С•Р Р†РЎвЂ№Р в„– РЎРѓРЎвЂљР В°РЎвЂљРЎС“РЎРѓ
```

### Р РЃР В°Р С– 2: Р В Р ВµР В°Р В»Р С‘Р В·Р С•Р Р†Р В°РЎвЂљРЎРЉ Р Р† Р С”Р С•Р Т‘Р Вµ
```bash
# 1. domain/ РІР‚вЂќ Р Т‘Р С•Р В±Р В°Р Р†Р С‘РЎвЂљРЎРЉ Р С—РЎР‚Р В°Р Р†Р С‘Р В»Р С• / Р СР С•Р Т‘Р ВµР В»РЎРЉ
# 2. usecases/ РІР‚вЂќ Р Т‘Р С•Р В±Р В°Р Р†Р С‘РЎвЂљРЎРЉ usecase
# 3. transport/routers РІР‚вЂќ Р Т‘Р С•Р В±Р В°Р Р†Р С‘РЎвЂљРЎРЉ РЎР‚Р С•РЎС“РЎвЂљ
# 4. adapters РІР‚вЂќ Р Т‘Р С•Р В±Р В°Р Р†Р С‘РЎвЂљРЎРЉ Р С‘Р Р…РЎвЂљР ВµР С–РЎР‚Р В°РЎвЂ Р С‘РЎР‹ (Р ВµРЎРѓР В»Р С‘ Р Р…РЎС“Р В¶Р Р…Р В°)
# 5. tests/ РІР‚вЂќ Р Т‘Р С•Р В±Р В°Р Р†Р С‘РЎвЂљРЎРЉ РЎвЂљР ВµРЎРѓРЎвЂљРЎвЂ№
```

### Р РЃР В°Р С– 3: Р СџРЎР‚Р С•Р Р†Р ВµРЎР‚Р С‘РЎвЂљРЎРЉ Р С”Р С•Р Р…РЎвЂљРЎР‚Р В°Р С”РЎвЂљ
```bash
# Р вЂ”Р В°Р С—РЎС“РЎРѓРЎвЂљР С‘РЎвЂљРЎРЉ tests/contract/
# Р СџРЎР‚Р С•Р Р†Р ВµРЎР‚Р С‘РЎвЂљРЎРЉ Swagger UI Р Р…Р В° http://localhost:8000/docs
# Р Р€Р В±Р ВµР Т‘Р С‘РЎвЂљРЎРЉРЎРѓРЎРЏ РЎвЂЎРЎвЂљР С• РЎРѓР С–Р ВµР Р…Р ВµРЎР‚Р С‘РЎР‚Р С•Р Р†Р В°Р Р…Р Р…РЎвЂ№Р в„– OpenAPI == api-contracts.yaml
```

### Р РЃР В°Р С– 4: Р С™Р С•Р СР СР С‘РЎвЂљ
```bash
git add -A
git commit -m "feat: [TAG] Р С•Р С—Р С‘РЎРѓР В°Р Р…Р С‘Р Вµ"
# Р СџРЎР‚Р С‘Р СР ВµРЎР‚РЎвЂ№ TAG: USER_REQUEST, SUPPLIER_SEARCH, MODERATOR_TASK
```

---

## 15. Р РЋР С•РЎРѓРЎвЂљР С•РЎРЏР Р…Р С‘Р Вµ Р С—РЎР‚Р С•Р ВµР С”РЎвЂљР В° РЎвЂћР С‘Р С”РЎРѓР С‘РЎР‚РЎС“Р ВµРЎвЂљРЎРѓРЎРЏ Р Р† HANDOFF.md

Р С™Р С•Р С–Р Т‘Р В° РЎвЂЎР В°РЎвЂљ Р В·Р В°Р С”Р В°Р Р…РЎвЂЎР С‘Р Р†Р В°Р ВµРЎвЂљРЎРѓРЎРЏ РІвЂ вЂ™ Р С•Р В±Р Р…Р С•Р Р†Р В»РЎРЏР ВµР С `HANDOFF.md` РЎРѓ РЎвЂљР ВµР С”РЎС“РЎвЂ°Р С‘Р С РЎРѓРЎвЂљР В°РЎвЂљРЎС“РЎРѓР С•Р С, РЎвЂЎРЎвЂљР С•Р В±РЎвЂ№ Р Р† Р Р…Р С•Р Р†Р С•Р С РЎвЂЎР В°РЎвЂљР Вµ Р Р…Р Вµ Р С—Р С•РЎвЂљР ВµРЎР‚РЎРЏРЎвЂљРЎРЉ Р С”Р С•Р Р…РЎвЂљР ВµР С”РЎРѓРЎвЂљ.

**Р В­РЎвЂљР С• Р С™Р В Р ВР СћР ВР В§Р СњР С› Р Т‘Р В»РЎРЏ Р Р…Р ВµР С—РЎР‚Р ВµРЎР‚РЎвЂ№Р Р†Р Р…Р С•РЎРѓРЎвЂљР С‘.**

---

## Р ВРЎвЂљР С•Р С–: "Р С™Р С•Р Р…РЎРѓРЎвЂљР С‘РЎвЂљРЎС“РЎвЂ Р С‘РЎРЏ" РЎРѓР С•Р В±Р В»РЎР‹Р Т‘Р В°Р ВµРЎвЂљРЎРѓРЎРЏ Р С—Р С•РЎвЂљР С•Р СРЎС“ РЎвЂЎРЎвЂљР С•:

1. **Р С™Р С•Р Т‘ Р Т‘Р С•Р В»Р С–Р С‘Р в„–** РІР‚вЂќ РЎРѓР С‘РЎРѓРЎвЂљР ВµР СР В° Р Т‘Р С•Р В»Р В¶Р Р…Р В° Р В¶Р С‘РЎвЂљРЎРЉ Р СР ВµРЎРѓРЎРЏРЎвЂ РЎвЂ№/Р С–Р С•Р Т‘РЎвЂ№.
2. **Р СџР ВµРЎР‚Р ВµР ВµР В·Р Т‘ Р Р†Р С•Р В·Р СР С•Р В¶Р ВµР Р…** РІР‚вЂќ FastAPI РІвЂ вЂ™ Node Р В±Р ВµР В· Р С—Р ВµРЎР‚Р ВµР С—Р С‘РЎРѓРЎвЂ№Р Р†Р В°Р Р…Р С‘РЎРЏ Р Т‘Р С•Р СР ВµР Р…Р В°.
3. **Р СњР С•Р Р†РЎвЂ№Р в„– РЎР‚Р В°Р В·РЎР‚Р В°Р В±Р С•РЎвЂљРЎвЂЎР С‘Р С” Р В±РЎвЂ№РЎРѓРЎвЂљРЎР‚Р С• Р С•РЎР‚Р С‘Р ВµР Р…РЎвЂљР С‘РЎР‚РЎС“Р ВµРЎвЂљРЎРѓРЎРЏ** РІР‚вЂќ РЎРѓРЎвЂљРЎР‚РЎС“Р С”РЎвЂљРЎС“РЎР‚Р В° Р С‘ Р С—РЎР‚Р В°Р Р†Р С‘Р В»Р В° РЎРЏРЎРѓР Р…РЎвЂ№.
4. **Р СњР Вµ РЎРѓРЎвЂљР В°Р Р…Р С•Р Р†Р С‘РЎвЂљРЎРѓРЎРЏ РЎРѓР Р†Р В°Р В»Р С”Р С•Р в„–** РІР‚вЂќ РЎРѓРЎвЂљРЎР‚Р С•Р С–Р В°РЎРЏ Р В°РЎР‚РЎвЂ¦Р С‘РЎвЂљР ВµР С”РЎвЂљРЎС“РЎР‚Р В° Р С‘ Р В·Р В°Р С—РЎР‚Р ВµРЎвЂљРЎвЂ№.

**Р СњР В°РЎР‚РЎС“РЎв‚¬Р ВµР Р…Р С‘Р Вµ Р С—РЎР‚Р В°Р Р†Р С‘Р В» = Р С”Р С•Р Т‘ Р Р…Р В° review Р Р…Р Вµ Р С—РЎР‚Р С•Р в„–Р Т‘РЎвЂРЎвЂљ.**

---

Р вЂ™Р ВµРЎР‚РЎРѓР С‘РЎРЏ: 1.0 Р С•РЎвЂљ 13.12.2025

## Environment defaults

- Default API port: **8000**.
- Default API prefix: **/api/v1**.
- Default DB stack: **SQLAlchemy 2.0 async + asyncpg** (sync psycopg2 Р Р…Р Вµ Р С‘РЎРѓР С—Р С•Р В»РЎРЉР В·РЎС“Р ВµР С).
- Local Postgres: РЎвЂћР С‘Р С”РЎРѓР С‘РЎР‚РЎС“Р ВµР С Р С•Р Т‘Р С‘Р Р… РЎР‚Р ВµР В¶Р С‘Р С (Р В»Р С•Р С”Р В°Р В»РЎРЉР Р…Р С• РЎС“РЎРѓРЎвЂљР В°Р Р…Р С•Р Р†Р В»Р ВµР Р…Р Р…РЎвЂ№Р в„– Р С‘Р В»Р С‘ Docker compose) Р С‘ Р С•РЎвЂљРЎР‚Р В°Р В¶Р В°Р ВµР С РЎРЊРЎвЂљР С• Р Р† `ENV.md`.
- Р СџРЎР‚Р В°Р Р†Р С‘Р В»Р С•: Р ВµРЎРѓР В»Р С‘ Р Р† РЎР‚Р ВµР С—Р С•Р В·Р С‘РЎвЂљР С•РЎР‚Р С‘Р С‘ Р ВµРЎРѓРЎвЂљРЎРЉ `ENV.md`, РЎвЂљР С• Р Р†Р С•Р С—РЎР‚Р С•РЎРѓРЎвЂ№ Р С—РЎР‚Р С• Р С•Р С”РЎР‚РЎС“Р В¶Р ВµР Р…Р С‘Р Вµ (Python/Postgres/DB stack/port/path) Р С—Р С•Р Р†РЎвЂљР С•РЎР‚Р Р…Р С• Р Р…Р Вµ Р В·Р В°Р Т‘Р В°РЎвЂР С РІР‚вЂќ Р С‘РЎРѓР С—Р С•Р В»РЎРЉР В·РЎС“Р ВµР С Р В·Р Р…Р В°РЎвЂЎР ВµР Р…Р С‘РЎРЏ Р С‘Р В· `ENV.md`.


## Process logging (hard rule)
- After EACH successfully completed step/milestone: append ONE entry to HANDOFF.md (append-only).
  Include: datetime MSK, what changed (files/endpoints/migrations), how verified (exact command + expected output).
- If a step FAILED or caused breakage: DO NOT write to HANDOFF.md; write to INCIDENTS.md (append-only).
  Include: datetime MSK, symptom, root cause, fix/mitigation, verification.
- No РІР‚Сљfake progressРІР‚Сњ: do not add endpoints to main.py if they cannot work end-to-end, unless they explicitly return 501 Not Implemented and this is logged.

## Windows workflow: write scripts only (hard rule)
- Any change to repo files must be delivered as a PowerShell script/commands that write or overwrite the target files (no "edit manually in editor" instructions).
- Use UTF-8 without BOM when writing text files (PowerShell can add BOM in some cases).
  Preferred approach:
  - $utf8NoBom = New-Object System.Text.UTF8Encoding($false)
  - [System.IO.File]::WriteAllText(path, content, $utf8NoBom)
- Each step must include:
  - "Write" commands (create/overwrite exact paths)
  - "Verification" commands (Select-String / python -c import / pytest / curl/Invoke-RestMethod)
- No temporary scripts that will be deleted later; if a helper script is introduced, it must live under /tools and be reusable.




## СЂСџвЂєВ РїС‘РЏ Р ВР Р…РЎРѓРЎвЂљРЎР‚РЎС“Р СР ВµР Р…РЎвЂљРЎвЂ№ Р С—РЎР‚Р С•Р ВµР С”РЎвЂљР В° (Р Р†РЎРѓР Вµ Р С—Р С•Р Т‘Р С”Р В»РЎР‹РЎвЂЎР ВµР Р…РЎвЂ№ РІСљвЂ¦)

| Р ВР Р…РЎРѓРЎвЂљРЎР‚РЎС“Р СР ВµР Р…РЎвЂљ | Р В Р С•Р В»РЎРЉ | Р С™Р С•Р СР В°Р Р…Р Т‘Р В° Р В·Р В°Р С—РЎС“РЎРѓР С”Р В° |
|------------|------|-----------------|
| **Ruff** | Р вЂєР С‘Р Р…РЎвЂљР ВµРЎР‚ + РЎвЂћР С•РЎР‚Р СР В°РЎвЂљРЎвЂљР ВµРЎР‚ | `just fmt` |
| **pre-commit** | Р СџРЎР‚Р С•Р Р†Р ВµРЎР‚Р С”Р С‘ Р С—Р ВµРЎР‚Р ВµР Т‘ Р С”Р С•Р СР СР С‘РЎвЂљР С•Р С | `backend\.venv\Scripts\pre-commit.exe run --all-files` |
| **GitHub Actions** | CI Р Р…Р В° Р С”Р В°Р В¶Р Т‘РЎвЂ№Р в„– push/PR | Р С’Р Р†РЎвЂљР С•Р СР В°РЎвЂљР С‘РЎвЂЎР ВµРЎРѓР С”Р С‘ Р Р† Checks |
| **just** | Task runner | `just fmt`, `just dev`, `just test` |
| **pyclean** | Р Р€Р В±Р С•РЎР‚Р С”Р В° __pycache__ | `pyclean backend` |
| **uv** | Р вЂРЎвЂ№РЎРѓРЎвЂљРЎР‚РЎвЂ№Р в„– pip | `uv pip install -r requirements.txt` |

**Р СџРЎР‚Р В°Р Р†Р С‘Р В»Р С•**: Р С—Р ВµРЎР‚Р ВµР Т‘ Р С”Р С•Р СР СР С‘РЎвЂљР С•Р С/Р С—РЎС“РЎв‚¬Р ВµР С Р Р†РЎРѓР ВµР С–Р Т‘Р В° `just fmt` + pre-commit.

### Absolute rule for assistant
- If the response implies ANY repo change (code, config, docs, CI, migrations) the assistant MUST provide runnable commands (PowerShell) that:
  - create/overwrite exact file paths, or
  - apply exact deterministic patches (no manual editor steps).
- If commands are not provided, the response is considered invalid and must be rewritten with scripts.
- Default format for file writes: UTF-8 without BOM via:
  - $utf8NoBom = New-Object System.Text.UTF8Encoding($false)
  - [System.IO.File]::WriteAllText(path, content, $utf8NoBom)


## Communication rules for assistant (hard rule)
- Treat the user as a product owner / Р В·Р В°Р С”Р В°Р В·РЎвЂЎР С‘Р С”, not as РЎР‚РЎРЏР Т‘Р С•Р Р†Р С•Р в„– РЎР‚Р В°Р В·РЎР‚Р В°Р В±Р С•РЎвЂљРЎвЂЎР С‘Р С”.
- Questions must be in simple, human language (Р В±Р ВµР В· Р С—Р ВµРЎР‚Р ВµР С–РЎР‚РЎС“Р В·Р В° РЎвЂљР ВµРЎР‚Р СР С‘Р Р…Р В°Р СР С‘), РЎРѓ Р СР С‘Р Р…Р С‘Р СРЎС“Р СР С•Р С Р Р†Р Р…РЎС“РЎвЂљРЎР‚Р ВµР Р…Р Р…Р ВµР в„– Р С”РЎС“РЎвЂ¦Р Р…Р С‘.
- Technical details (РЎвЂљР С‘Р С—РЎвЂ№, Р С—РЎС“РЎвЂљР С‘ РЎвЂћР В°Р в„–Р В»Р С•Р Р†, Р С”Р С•Р СР В°Р Р…Р Т‘РЎвЂ№) Р Т‘Р В°Р Р†Р В°РЎвЂљРЎРЉ, Р Р…Р С• Р С•Р В±РЎР‰РЎРЏРЎРѓР Р…Р ВµР Р…Р С‘РЎРЏ РЎвЂћР С•РЎР‚Р СРЎС“Р В»Р С‘РЎР‚Р С•Р Р†Р В°РЎвЂљРЎРЉ РЎвЂљР В°Р С”, РЎвЂЎРЎвЂљР С•Р В±РЎвЂ№ Р С‘РЎвЂ¦ Р СР С•Р В¶Р Р…Р С• Р В±РЎвЂ№Р В»Р С• Р С—Р С•Р Р…Р С‘Р СР В°РЎвЂљРЎРЉ Р Р…Р В° РЎС“РЎР‚Р С•Р Р†Р Р…Р Вµ РІР‚СљРЎвЂЎРЎвЂљР С• РЎРЊРЎвЂљР С• Р Т‘Р В°РЎвЂРЎвЂљ Р С—РЎР‚Р С•Р Т‘РЎС“Р С”РЎвЂљРЎС“РІР‚Сњ.
- Р вЂўРЎРѓР В»Р С‘ Р Р…РЎС“Р В¶Р Р…Р С• РЎРѓР С—РЎР‚Р С•РЎРѓР С‘РЎвЂљРЎРЉ Р С—РЎР‚Р С• Р В°РЎР‚РЎвЂ¦Р С‘РЎвЂљР ВµР С”РЎвЂљРЎС“РЎР‚РЎС“/РЎР‚Р ВµРЎв‚¬Р ВµР Р…Р С‘Р Вµ, РЎРѓР Р…Р В°РЎвЂЎР В°Р В»Р В° Р С”Р С•РЎР‚Р С•РЎвЂљР С”Р С• РЎРѓРЎвЂћР С•РЎР‚Р СРЎС“Р В»Р С‘РЎР‚Р С•Р Р†Р В°РЎвЂљРЎРЉ РЎРѓРЎС“РЎвЂљРЎРЉ Р Р†РЎвЂ№Р В±Р С•РЎР‚Р В° (Р Р†Р В°РЎР‚Р С‘Р В°Р Р…РЎвЂљ A/Р Р†Р В°РЎР‚Р С‘Р В°Р Р…РЎвЂљ B) Р С•Р В±РЎвЂ№РЎвЂЎР Р…РЎвЂ№Р С РЎРЏР В·РЎвЂ№Р С”Р С•Р С, Р В° РЎС“Р В¶Р Вµ Р С—Р С•РЎвЂљР С•Р С РІР‚вЂќ РЎвЂљР ВµРЎвЂ¦Р Р…Р С‘РЎвЂЎР ВµРЎРѓР С”Р С‘Р Вµ Р Т‘Р ВµРЎвЂљР В°Р В»Р С‘.


## GitHub progress as SSoT (hard rule)
- Progress and current state are tracked in GitHub (main branch) to avoid losing context between chats.
- After each completed milestone:
  - Update HANDOFF.md (append-only) with datetime MSK, what changed, how verified (exact command + expected output).
  - Commit and push to origin/main.
- When a milestone fails or causes breakage:
  - Write to INCIDENTS.md (append-only), then commit and push.
- Start-of-chat protocol:
  - Provide raw links to api-contracts.yaml, PROJECT-RULES.md, HANDOFF.md (and INCIDENTS.md if relevant) at HEAD of main.


---

## Start-of-work preflight (mandatory)

## PRE-FLIGHT (HARD RULE №4)

Before any conclusions like “fix wiring/routes/endpoint”, run preflight to avoid guesswork:

- Determine BASE_URL and API_PREFIX:

  - Plan A: read from runtime/env (commonly APPPORT, APIPREFIX).

  - Plan B: ask the user for current base url (host:port) and API prefix of the running backend.

  - Never assume defaults unless confirmed.

- Ensure backend is started from the same shell where env is set (or via a dev script):

  - Minimum: PYTHONPATH.

  - If routers/modules are DB-dependent at import-time: DATABASEURL and/or DATABASE_URL must be set.

- Run and show 3 checks (with expected results):

  1) Invoke-RestMethod "$BASE_URL/$API_PREFIX/health"

     Expected: JSON with status="ok" (or equivalent per api-contracts.yaml).

  2) Invoke-RestMethod "$BASE_URL/openapi.json" | Out-Null

     Expected: HTTP 200 and valid JSON.

  3) python -c "import os; print(os.getenv('DATABASEURL'), os.getenv('DATABASE_URL'))"

     Expected: not None only if backend/routers require DB at import-time.

- If any check fails: provide Plan B commands before proposing code changes.




Before changing wiring/routers/tests, run a preflight to avoid guesswork:

- Tools presence check: ruff, pre-commit, pyclean, uv, direnv, just; if missing, use Plan B commands.

- Environment check: DATABASEURL or DATABASE_URL must be set for any code paths that import DB/session at import-time.

- Run backend only from a shell where env is explicitly set (or via a single dev script) to avoid вЂњworks in one console, fails in anotherвЂќ.

- Verification baseline: /apiv1/health returns ok and /openapi.json is reachable.



PowerShell reference preflight snippet:

- Activate venv, set PYTHONPATH, set DATABASEURL and DATABASE_URL, then start uvicorn.

---
