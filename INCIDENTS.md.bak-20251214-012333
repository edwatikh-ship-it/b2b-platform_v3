# INCIDENTS.md

## Rules (owned here)
- Log problems/failures here (append-only).
- Format: datetime MSK — symptom — root cause — fix/mitigation — verification.
- 1–3 lines per entry, no long stacktraces.

## Entries (append-only)
# INCIDENTS.md — known issues / pitfalls (append-only)

Rule:
- Log important failures/incidents here.
- Format: datetime MSK — symptom — root cause — fix/mitigation — verification.
- 1–3 lines per incident, no long stacktraces.

## Entries (append-only)
- 2025-12-13 23:49 MSK pytest on Windows failed with "Event loop is closed" when hitting Postgres via asyncpg in integration tests — root cause: global SQLAlchemy async engine not disposed on app shutdown — fix: FastAPI lifespan + `await engine.dispose()` in `app/main.py` — verification: `python -m pytest -q` -> `2 passed`.
- 2025-12-13 23:49 MSK pytest on Windows failed with "Event loop is closed" when hitting Postgres via asyncpg — root cause: SQLAlchemy async engine created globally and not disposed on shutdown — fix: FastAPI lifespan + await engine.dispose() — verification: python -m pytest -q => 2 passed.

- 2025-12-13 23:56 MSK RequestDetail implemented with suppliers=[] and normalizedtext=rawtext as placeholder — mitigation: later add supplier matching + normalization — verification: python -m pytest -q => 4 passed.
- 2025-12-14 00:05 MSK FAILED Attachments implementation: pytest collection crashed due to SyntaxError in app/adapters/db/models.py (broken 'from sqlalchemy import' line after patch). Fix: restored import block and converted AttachmentModel to SQLAlchemy 2.0 style; verification: python -c 'from app.adapters.db.models import ...' -> models import ok.
- 2025-12-14 00:05–00:24 MSK INCIDENT: backend/alembic failed due to missing DATABASE_URL in .env and mismatch between expected DB user/db (b2buser/b2bplatform) and actual (b2b_user/b2b_platform); also migration 0dc050e5c206 was applied with empty upgrade(). Fix: wrote DATABASE_URL to .env, aligned DATABASE_URL to b2b_user/b2b_platform, created new migration bbff04c57403 to create attachments table. Verified with alembic current + psql \dt.
- 2025-12-14 00:35–00:36 MSK INCIDENT: pytest failed with unexpected line: '\\ufeff[pytest]' because pytest.ini was written with UTF-8 BOM by PowerShell Set-Content; fix: rewrite pytest.ini as UTF-8 without BOM via .NET UTF8Encoding(false). Verified: pytest -q => 10 passed.
- 2025-12-14 00:05–00:24 MSK INCIDENT: DB/env mismatch and missing DATABASE_URL caused alembic/settings failures; actual role/db were b2b_user/b2b_platform. Fix: added DATABASE_URL to .env pointing to b2b_user/b2b_platform and created migration bbff04c57403 to add attachments table. Verified with alembic current + psql \dt.
- 2025-12-14 00:35–00:36 MSK INCIDENT: pytest failed with unexpected line '\ufeff[pytest]' because pytest.ini was written with UTF-8 BOM; fix: rewrite pytest.ini as UTF-8 without BOM via .NET UTF8Encoding(false). Verified: pytest -q => 10 passed.
- 2025-12-14 00:35–00:36 MSK INCIDENT: pytest.ini written with UTF-8 BOM caused pytest error (unexpected line '\ufeff[pytest]'). Fix: rewrite pytest.ini UTF-8 without BOM via .NET UTF8Encoding(false). Verified: pytest -q => 10 passed.
- 2025-12-14 0016 MSK INCIDENT <symptom>. Root cause: <root_cause>. Fix/mitigation: <fix>. Verification: <command> -> <expected>.
