# PROJECT-DOC — Продуктовые правила (SSoT после api-contracts.yaml и PROJECT-RULES.md)

## Назначение
Этот документ фиксирует продуктовые/бизнес‑правила, которые НЕ описаны в OpenAPI‑контрактах.
Цель: избежать постоянных уточнений и «угадывания» правил при разработке backend.

## Основной процесс (Пользователь → Модератор → Авто‑доставка)

### 1) Создание запроса и ключей
- Пользователь создаёт Request и задаёт список «ключей» (позиций).
- Ключи могут вводиться вручную или появляться после распознавания файла (план: парсинг на базе OpenAI, который превращает файл в ключи).
- Пользователь просматривает распознанные ключи и подтверждает, что запрос корректный.

### 2) Действие «Получить контакты поставщиков» (запуск матчинга + создание задачи модератору)
Когда пользователь нажимает «Получить контакты поставщиков»:
- Система запускает matching для каждого ключа по имеющимся данным в базе.
- Параллельно система создаёт Moderator Task для этого запроса (запрос “разбивается” по ключам для обработки).

### 3) Процесс парсинга у модератора
- Модератор открывает задачу по запросу и запускает парсер (на базе поисковых систем).
- Парсер прогоняет каждый ключ через Google и Yandex и возвращает список URL для каждого ключа.

### 4) Обработка URL и доставка пользователю
Для каждого URL, который вернул парсер:
- Если URL уже есть в БД И он “модерирован” (см. определение ниже),
  то контакт поставщика сразу доставляется в ЛК пользователя
  и связывается с этим запросом + конкретным ключом, который дал URL.
- Если URL новый или не модерирован, он проходит модерацию.
  Как только модератор подтверждает и привязывает его к ключу — контакт доставляется пользователю.

## Что видит пользователь в ЛК (карточка поставщика)
Для каждого поставщика, доставленного пользователю, интерфейс должен показывать минимум:
- Название компании
- ИНН
- URL компании
- Дополнительные сведения о компании из Checko API (если доступны)
- Возможность отправить запрос поставщику (ветка messaging)

## Определение: «Модерированный поставщик / модерированный URL» (жёсткое требование)
Компания/URL может храниться как «пригодный поставщик», только если модератор привязал минимум данных:
- URL компании
- ИНН
- Название компании
- Email отдела продаж (контактный ящик для запросов)
Только после этого поставщик считается модерированным и может автоматически доставляться пользователям.

## Правила matching: «похожий ключ» (MVP → улучшения)

### Цель
Matching должен возвращать действительно релевантных поставщиков для ключа.
Пример: ключ «Фланец d100» должен матчиться на ключ в БД типа «Фланец плоский d100».

### Рекомендованный подход для MVP (детерминированный и объяснимый)
1) Нормализация текста ключа:
   - Приведение к нижнему регистру, обрезка пробелов, унификация символов (например d/ø/д), нормализация «ё/е».
   - Числовые/размерные токены считаются важными (например 100).
2) Извлечение «обязательных параметров»:
   - Размеры/диаметры (d=100), ГОСТ, марка стали и т.п. (по шаблонам).
3) Решение о совпадении:
   - Обязательные параметры должны совпасть (например d=100).
   - Текстовая похожесть должна быть выше порога (варианты: пересечение токенов или trigram similarity).
4) Объяснимость:
   - Храним “почему совпало” (какие параметры и токены совпали), чтобы matching не был “чёрным ящиком”.

### Примечания
- Пороги и точный алгоритм будут тюниться по реальным данным.
- В MVP избегаем ML/black‑box; начинаем с детерминированного matching.

## Требования к связям данных (концептуально)
- Каждый доставленный поставщик должен быть связан с:
  - Запросом (requestId)
  - Ключом (keyId/pos), который привёл к поставщику
  - Source URL (и признаком: URL был известен в БД или найден парсером)

## Открытые вопросы (решим позже, MVP не блокируют)
- Как кешируются и обновляются данные Checko API.
- Точный UI карточки поставщика (минимальный набор полей зафиксирован выше).
- Детали интеграции парсера и эксплуатационные ограничения.

## Статусы поставщиков в ЛК (MVP)

### Когда поставщик считается “модерированным”
Поставщик считается пригодным для выдачи пользователю (модерированным), только если модератор привязал минимум данных:
- URL компании
- ИНН
- Название компании
- Email отдела продаж (почтовый ящик, на который отправляются запросы)

### Значение цветов/статусов
- Серый: ИНН поставщика добавлен пользователем в личный ЧС. Поставщик всё равно показывается в выдаче, но чекбокс “выделить к отправке” по умолчанию выключен.
- Фиолетовый: поставщик помечен как “торгующая организация / перекуп”. Это глобальная метка (для всех пользователей). Чекбокс по умолчанию выключен.
- Жёлтый: новый поставщик появился в результате пополнения базы после модерации. Остаётся жёлтым, пока пользователь либо снимет галочку (явно “не отправлять”), либо отправит запрос.
- Красный: запрос не отправлен (типовое стартовое состояние для “обычных” поставщиков).
- Зелёный: запрос отправлен.

### Индикация ответа
Дополнительно нужна индикация: ответил поставщик на запрос или нет (ответил / не ответил).

### Ограничение MVP (почта не подключена)
Пока почтовый ящик пользователя не интегрирован в ЛК, отправка писем из сервиса не работает (заглушка).
Пользователь может только скопировать контакты поставщика и отправить запрос из своей почты; статусы отправки/ответа — заглушки до внедрения интеграции.

## Поставщики: поиск и доступы
- Поиск поставщиков по строке: модератор использует в админке.
- Модератор может включать/выключать доступность строки поиска для пользователей из своего ЛК (фича‑флаг).
- По умолчанию в пользовательском интерфейсе строка поиска скрыта (пока модератор не включил).
- Данные поставщика: ИНН строго один на поставщика.
- Данные поставщика: URL у поставщика может быть несколько (редко, но возможно).
- Уникальность URL: один сайт (URL) не может принадлежать двум поставщикам (глобальная уникальность).

## Дубли по ИНН (ModeratorSuppliers)
Если модератор пытается создать поставщика с ИНН, который уже существует в базе, создание блокируется.

API: POST /apiv1/moderator/suppliers возвращает 409 Duplicate INN с телом DuplicateInnErrorDTO.

UI: открывается экран сравнения дублей:
- Слева: incomingurl (+ введённый ИНН/название если есть)
- Справа: существующая компания (supplierid, name) и все её urls (кликабельные, открываются в новой вкладке)
- Действие: только “перейти в карточку предприятия”